generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Rol {
  id     Int    @id @default(autoincrement())
  nombre String

  estudiantes     Estudiante[]
  docentes        Docente[]
  administradores Administrador[]
}

model Carrera {
  id          Int      @id @default(autoincrement())
  nombre      String   @unique
  descripcion String?
  clave       String   @unique
  createdAt   DateTime @default(now()) @map("created_at")

  estudiantes Estudiante[]
  docentes    Docente[]
  grupos      Grupo[]
  asignaturas Asignatura[]
}

model Estudiante {
  id          Int      @id @default(autoincrement())
  nombre      String
  apellidos   String
  matricula   String   @unique
  correo      String   @unique
  direccion   String
  telefono    String   @unique
  estado      String
  contraseña String
  createdAt   DateTime @default(now()) @map("created_at")

  rolId     Int
  carreraId Int

  rol     Rol     @relation(fields: [rolId], references: [id])
  carrera Carrera @relation(fields: [carreraId], references: [id])

  inscripciones  InscripcionGrupo[]
  calificaciones Calificacion[]
  asistencias    Asistencia[]
}

model Docente {
  id          Int      @id @default(autoincrement())
  nombre      String
  apellidos   String
  telefono    String   @unique
  correo      String   @unique
  contraseña String
  createdAt   DateTime @default(now()) @map("created_at")

  rolId     Int
  carreraId Int?

  rol     Rol      @relation(fields: [rolId], references: [id])
  carrera Carrera? @relation(fields: [carreraId], references: [id])

  grupos      Grupo[] // Grupos donde es tutor
  asignaturas AsignaturaDocente[] // Asignaturas que imparte
}

model Administrador {
  id          Int      @id @default(autoincrement())
  nombre      String
  apellidos   String
  correo      String   @unique
  contraseña String
  createdAt   DateTime @default(now()) @map("created_at")

  rolId Int
  rol   Rol @relation(fields: [rolId], references: [id])
}

model Tutor {
  id        Int      @id @default(autoincrement())
  nombre    String
  apellidos String
  createdAt DateTime @default(now()) @map("created_at")
}

model Turno {
  id          Int      @id @default(autoincrement())
  nombre      String
  hora_inicio DateTime
  hora_fin    DateTime
  createdAt   DateTime @default(now()) @map("created_at")

  grupos Grupo[]
}

model Grupo {
  id               Int      @id @default(autoincrement())
  nombre           String
  semestre         Int
  capacidad_maxima Int      @default(40)
  createdAt        DateTime @default(now()) @map("created_at")

  turnoId   Int
  carreraId Int
  docenteId Int?

  turno   Turno    @relation(fields: [turnoId], references: [id])
  carrera Carrera  @relation(fields: [carreraId], references: [id])
  docente Docente? @relation(fields: [docenteId], references: [id])

  asignaturas   AsignaturaDocente[]
  inscripciones InscripcionGrupo[]
}

model Asignatura {
  id              Int      @id @default(autoincrement())
  nombre          String
  clave           String   @unique
  creditos        Int
  horas_semanales Int
  semestre        Int
  descripcion     String?
  createdAt       DateTime @default(now()) @map("created_at")

  carreraId Int
  carrera   Carrera @relation(fields: [carreraId], references: [id])

  docentes AsignaturaDocente[]
}

model AsignaturaDocente {
  id           Int      @id @default(autoincrement())
  asignaturaId Int
  docenteId    Int
  grupoId      Int
  cicloEscolar String
  createdAt    DateTime @default(now()) @map("created_at")

  asignatura Asignatura @relation(fields: [asignaturaId], references: [id])
  docente    Docente    @relation(fields: [docenteId], references: [id])
  grupo      Grupo      @relation(fields: [grupoId], references: [id])

  calificaciones Calificacion[]
  horarios       Horario[]
  asistencias    Asistencia[] // ⚠️ Aquí añadimos la relación inversa

  @@unique([asignaturaId, grupoId, cicloEscolar], name: "unico_asignatura_grupo")
}

model InscripcionGrupo {
  id               Int      @id @default(autoincrement())
  estudianteId     Int
  grupoId          Int
  ciclo_escolar    String
  fechaInscripcion DateTime
  estado           String   @default("Activo")
  createdAt        DateTime @default(now()) @map("created_at")

  estudiante Estudiante @relation(fields: [estudianteId], references: [id])
  grupo      Grupo      @relation(fields: [grupoId], references: [id])

  @@unique([estudianteId, grupoId, ciclo_escolar], name: "unico_estudiante_grupo_ciclo")
}

model Horario {
  id                   Int      @id @default(autoincrement())
  asignatura_docenteId Int
  dia_semana           String
  hora_inicio          DateTime
  hora_fin             DateTime
  aula                 String
  createdAt            DateTime @default(now()) @map("created_at")

  asignatura_docente AsignaturaDocente @relation(fields: [asignatura_docenteId], references: [id])
}

model PeriodoEvaluacion {
  id            Int      @id @default(autoincrement())
  nombre        String
  fecha_inicio  DateTime
  fecha_fin     DateTime
  ciclo_escolar String
  porcentaje    Float
  createdAt     DateTime @default(now()) @map("created_at")

  calificaciones Calificacion[]
}

model Calificacion {
  id                   Int      @id @default(autoincrement())
  estudianteId         Int
  asignatura_docenteId Int
  periodo_evaluacionId Int
  calificacion         Float
  faltas               Int      @default(0)
  observaciones        String?
  fecha_registro       DateTime @default(now())

  estudiante         Estudiante        @relation(fields: [estudianteId], references: [id])
  asignatura_docente AsignaturaDocente @relation(fields: [asignatura_docenteId], references: [id])
  periodo_evaluacion PeriodoEvaluacion @relation(fields: [periodo_evaluacionId], references: [id])

  @@unique([estudianteId, asignatura_docenteId, periodo_evaluacionId], name: "unico_calificacion")
}

model Asistencia {
  id                   Int      @id @default(autoincrement())
  estudianteId         Int
  asignatura_docenteId Int
  fecha                DateTime
  estado               String
  observaciones        String?
  createdAt            DateTime @default(now()) @map("created_at")

  estudiante         Estudiante        @relation(fields: [estudianteId], references: [id])
  asignatura_docente AsignaturaDocente @relation(fields: [asignatura_docenteId], references: [id])

  @@unique([estudianteId, asignatura_docenteId, fecha], name: "unico_asistencia")
}
